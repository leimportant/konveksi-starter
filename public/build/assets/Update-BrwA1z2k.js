import{d as B,q as F,r as y,T as U,w as $,o as A,f as l,g as n,p as S,u as m,Z as I,x as R,k as i,C as z,y as T,j as x,l as q,F as h,B as k,U as D,m as E,V as j}from"./app-CimJA_nk.js";import{u as L}from"./useToast-CpetNM6S.js";import{u as Q}from"./useProductionStore-pmMYHDEd.js";import{u as Z}from"./useModelStore-DHWovAlh.js";import{u as G}from"./useMasterActivityRoleStore-2liFWHtz.js";import{_ as H}from"./AppLayout.vue_vue_type_script_setup_true_lang-Bz30gTPr.js";import"./index-Wul87X9J.js";import"./AppLogoIcon.vue_vue_type_script_setup_true_lang-7jnDcA66.js";const J={class:"p-4 md:p-6 space-y-4 md:space-y-6"},K={class:"text-xl md:text-2xl font-bold"},O={key:0},W={class:"w-full"},X=["value"],Y={key:0,class:"overflow-x-auto"},ee={class:"w-full table-auto border text-sm md:"},te={class:"border px-2 md:px-3 py-1 md:py-2"},oe={class:"border px-2 md:px-3 py-1 md:py-2"},ie=["onUpdate:modelValue"],se={class:"flex gap-2"},de=["disabled"],ye=B({__name:"Update",props:{id:{},activity_role:{}},setup(M){const _=L(),g=Q(),v=Z(),N=G(),{models:C}=F(v),u=M,p=y(null),r=y([]),f=y(null),s=U({id:null,model_id:null,activity_role_id:Number(u.activity_role),items:[]}),P=async()=>{try{const t=await g.fetchProductionsById(u.id);if(!t)throw new Error("No production data received");s.id=t.id,s.model_id=t.model_id,s.activity_role_id=t.activity_role_id,p.value=t.model_id,Array.isArray(t.items)?(r.value=t.items.map(e=>({size_id:String(e.size_id),size_name:e.size.name,qty:e.qty})),s.items=t.items.map(e=>({size_id:String(e.size_id),qty:e.qty||0}))):(r.value=[],s.items=[])}catch(t){console.error("Failed to fetch production data",t),_.error("Failed to fetch production data"),r.value=[],s.items=[]}},w=y(!0);$(p,async t=>{if(!(!t||w.value))try{const e=await v.fetchModelById(Number(t));if(!e)throw new Error("No model data received");s.model_id=e.id;const d=[...s.items];Array.isArray(e.sizes)?(r.value=e.sizes.map(o=>{var a;return{size_id:String(o.id),size_name:o.name,qty:((a=d.find(c=>c.size_id===String(o.id)))==null?void 0:a.qty)||0}}),s.items=e.sizes.map(o=>{var a;return{size_id:String(o.id),qty:((a=d.find(c=>c.size_id===String(o.id)))==null?void 0:a.qty)||0}})):(r.value=[],s.items=[])}catch(e){console.error("Failed to fetch model sizes",e),r.value=[],s.items=[]}}),A(async()=>{await v.fetchModels();try{const t=await N.getActivityRoleById(Number(u.activity_role));f.value=t}catch(t){console.error("Failed to fetch activity role",t)}await P(),w.value=!1});const V=async()=>{var t,e;try{await g.updateProduction(String(s.id),{model_id:s.model_id,activity_role_id:s.activity_role_id,items:s.items.filter(d=>d.qty>0)}),_.success("Production updated successfully"),window.location.href=`/production/${s.activity_role_id}`}catch(d){_.error(((e=(t=d==null?void 0:d.response)==null?void 0:t.data)==null?void 0:e.message)??"Failed to update production")}};return(t,e)=>(n(),l(h,null,[S(m(I),{title:"Update Production"}),S(H,{breadcrumbs:[{title:"Production",href:`/production/${u.activity_role}`}]},{default:R(()=>{var d;return[i("div",J,[i("h1",K,[e[2]||(e[2]=T(" Update Production")),f.value?(n(),l("span",O," - "+x((d=f.value)==null?void 0:d.name),1)):z("",!0)]),i("div",W,[e[4]||(e[4]=i("label",{class:"block font-medium mb-1"},"Select Model",-1)),q(i("select",{"onUpdate:modelValue":e[0]||(e[0]=o=>p.value=o),class:"border p-2 rounded w-full text-sm md:"},[e[3]||(e[3]=i("option",{disabled:"",value:""},"-- Choose a model --",-1)),(n(!0),l(h,null,k(m(C),o=>(n(),l("option",{key:o.id,value:o.id},x(o.description),9,X))),128))],512),[[D,p.value]])]),r.value.length>0?(n(),l("div",Y,[e[6]||(e[6]=i("h2",{class:"font-semibold mb-2"},"Model Sizes",-1)),i("table",ee,[e[5]||(e[5]=i("thead",null,[i("tr",{class:"bg-gray-100"},[i("th",{class:"border px-2 md:px-3 py-1 md:py-2 text-left"},"Size"),i("th",{class:"border px-2 md:px-3 py-1 md:py-2 text-left"},"Qty")])],-1)),i("tbody",null,[(n(!0),l(h,null,k(m(s).items,(o,a)=>{var c;return n(),l("tr",{key:`size-${a}-${o.size_id}`},[i("td",te,x(((c=r.value.find(b=>b.size_id===o.size_id))==null?void 0:c.size_name)||o.size_id),1),i("td",oe,[q(i("input",{type:"number",min:"0",class:"border rounded px-2 py-1 w-full","onUpdate:modelValue":b=>o.qty=b},null,8,ie),[[E,o.qty,void 0,{number:!0}]])])])}),128))])])])):z("",!0),i("div",se,[i("button",{onClick:V,class:"bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700",disabled:m(s).processing}," Save ",8,de),i("button",{onClick:e[1]||(e[1]=o=>m(j).visit(`/production/${u.activity_role}`)),type:"button",class:"bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600"}," Cancel ")])])]}),_:1},8,["breadcrumbs"])],64))}});export{ye as default};
