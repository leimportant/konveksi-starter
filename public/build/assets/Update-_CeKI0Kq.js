import{d as B,q as F,r as _,T as I,w as R,o as T,f as n,g as c,p as S,u as m,Z as $,x as A,k as o,C as w,y as D,j as v,l as q,F as g,B as N,U as j,m as E,V as k}from"./app-Bh0qDmz6.js";import{u as L}from"./useToast-DJ41H3Di.js";import{u as Q}from"./useProductionStore-Bl-bmfVp.js";import{u as Z}from"./useModelStore-DuZ1avUZ.js";import{u as G}from"./useMasterActivityRoleStore-B7lWVKNR.js";import{_ as H}from"./AppLayout.vue_vue_type_script_setup_true_lang-CkH9CgR8.js";import"./index-Q10Uzk3E.js";import"./AppLogoIcon.vue_vue_type_script_setup_true_lang-BtJ14SAw.js";const J={class:"p-4 md:p-6 space-y-6"},K={class:"text-xl md:text-2xl font-bold"},O={key:0},W=["value"],X={key:0,class:"overflow-x-auto"},Y={class:"w-full table-auto border text-sm"},tt={class:"border px-3 py-2"},et={class:"border px-3 py-2"},ot={class:"border px-3 py-2"},it=["onUpdate:modelValue"],st={class:"flex gap-2"},at=["disabled"],yt=B({__name:"Update",props:{id:{},activity_role:{},returnUrl:{}},setup(M){const p=L(),h=Q(),f=Z(),U=G(),{models:V}=F(f),r=M,y=_(null),u=_([]),b=_(null),a=I({id:null,model_id:null,activity_role_id:Number(r.activity_role),items:[]}),z=_(!0),C=async()=>{try{const i=await h.fetchProductionsById(r.id);a.id=i.id,a.model_id=i.model_id,a.activity_role_id=i.activity_role_id,y.value=i.model_id,Array.isArray(i.items)&&(u.value=i.items.map(t=>({size_id:String(t.size_id),size_name:t.size.name,qty:t.qty})),a.items=i.items.map(t=>({size_id:String(t.size_id),qty:t.qty,variant:t.variant||""})))}catch(i){console.error("Failed to fetch model sizes:",i),p.error("Failed to fetch production data: "+((i==null?void 0:i.message)||i))}};R(y,async i=>{if(!(!i||z.value))try{const t=await f.fetchModelById(Number(i));if(!t)return;a.model_id=t.id;const e=[...a.items];u.value=t.sizes.map(s=>{var d;return{size_id:String(s.id),size_name:s.name,qty:((d=e.find(l=>l.size_id===String(s.id)))==null?void 0:d.qty)||0}}),a.items=t.sizes.map(s=>{var d,l;return{size_id:String(s.id),qty:((d=e.find(x=>x.size_id===String(s.id)))==null?void 0:d.qty)||0,variant:((l=e.find(x=>x.size_id===String(s.id)))==null?void 0:l.variant)||""}})}catch(t){console.error("Failed to fetch model sizes:",t),p.error("Failed to fetch production data"),a.items=[],u.value=[]}}),T(async()=>{await f.fetchModels({page:1,is_close:"N"});try{b.value=await U.getActivityRoleById(Number(r.activity_role))}catch{}await C(),z.value=!1});const P=async()=>{var i,t;try{const e=a.items.map(s=>({size_id:s.size_id,qty:Number(s.qty)||0,variant:s.variant||""})).filter(s=>s.qty>0);await h.updateProduction(String(a.id),{model_id:a.model_id,activity_role_id:a.activity_role_id,items:e}),p.success("Production updated successfully"),k.visit(r.returnUrl??`/production/${r.activity_role}/create/N`)}catch(e){p.error(((t=(i=e==null?void 0:e.response)==null?void 0:i.data)==null?void 0:t.message)??"Failed to update production")}};return(i,t)=>(c(),n(g,null,[S(m($),{title:"Update Production"}),S(H,{breadcrumbs:[{title:"Production",href:`/production/${r.activity_role}`}]},{default:A(()=>[o("div",J,[o("h1",K,[t[2]||(t[2]=D(" Update Production ")),b.value?(c(),n("span",O,"- "+v(b.value.name),1)):w("",!0)]),o("div",null,[t[4]||(t[4]=o("label",{class:"block font-medium mb-1"},"Select Model",-1)),q(o("select",{"onUpdate:modelValue":t[0]||(t[0]=e=>y.value=e),class:"border p-2 rounded w-full text-sm"},[t[3]||(t[3]=o("option",{disabled:"",value:""},"-- Choose a model --",-1)),(c(!0),n(g,null,N(m(V),e=>(c(),n("option",{key:e.id,value:e.id},v(e.description),9,W))),128))],512),[[j,y.value]])]),u.value.length>0?(c(),n("div",X,[t[6]||(t[6]=o("h2",{class:"font-semibold mb-2"},"Model Sizes",-1)),o("table",Y,[t[5]||(t[5]=o("thead",null,[o("tr",{class:"bg-gray-100"},[o("th",{class:"border px-3 py-2 text-left"},"Size"),o("th",{class:"border px-3 py-2 text-left"},"Variant"),o("th",{class:"border px-3 py-2 text-left"},"Qty")])],-1)),o("tbody",null,[(c(!0),n(g,null,N(m(a).items,(e,s)=>{var d;return c(),n("tr",{key:s},[o("td",tt,v((d=u.value.find(l=>l.size_id===e.size_id))==null?void 0:d.size_name),1),o("td",et,v(e.variant),1),o("td",ot,[q(o("input",{"onUpdate:modelValue":l=>e.qty=l,min:"0",type:"number",class:"border rounded px-2 w-full"},null,8,it),[[E,e.qty,void 0,{number:!0}]])])])}),128))])])])):w("",!0),o("div",st,[o("button",{onClick:P,class:"bg-blue-600 text-white px-4 py-2 rounded",disabled:m(a).processing}," Save ",8,at),o("button",{onClick:t[1]||(t[1]=e=>m(k).visit(r.returnUrl??`/production/${r.activity_role}/create/N`)),type:"button",class:"rounded text-sm bg-gray-500 px-4 py-2 text-white hover:bg-gray-600"}," Cancel ")])])]),_:1},8,["breadcrumbs"])],64))}});export{yt as default};
