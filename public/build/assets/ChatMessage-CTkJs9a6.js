import{d as E,f as o,g as r,z as p,A as F,Q as L,r as x,c as G,o as H,w as J,a as Q,p as d,u as i,Z,x as _,k as a,F as m,B as k,C,j as u,D as S,y as $,E as q,G as W,n as D}from"./app-D3gc-nXC.js";import{u as X,a as Y,b as O,c as ee,_ as se,g as te}from"./AppLayout.vue_vue_type_script_setup_true_lang-Kf_Wf34O.js";import{_ as ae}from"./Input.vue_vue_type_script_setup_true_lang-Du5wuF9B.js";import"./index-QF4AC6ev.js";import"./AppLogoIcon.vue_vue_type_script_setup_true_lang-C57zbfb5.js";const re=E({__name:"ScrollArea",props:{customClass:{}},setup(M){return(v,g)=>(r(),o("div",{class:p(["overflow-y-auto",v.customClass]),ref:"container"},[F(v.$slots,"default")],2))}}),oe={class:"flex h-full flex-col gap-4 p-2"},ne={key:0,class:"bg-gray-40 gap-2 rounded-lg p-4 py-2"},ie={class:"space-y-2"},le=["onClick"],ce={class:"flex items-center justify-between"},de={class:"font-semibold"},ue={key:0,class:"inline-flex h-5 w-5 items-center justify-center rounded-full bg-indigo-600 text-xs font-semibold text-white"},_e={class:"truncate text-sm text-gray-600"},fe={key:1,class:"flex h-[75vh] flex-col overflow-hidden rounded-lg border bg-white"},ge={class:"flex items-center justify-between border-b bg-gray-50 p-4"},he={class:"text-lg font-semibold"},me={class:"flex-1 overflow-hidden bg-gray-50 p-4"},pe={class:"space-y-4"},ve={class:"max-w-[75%] space-y-1"},ye={class:"whitespace-pre-wrap break-words"},we={key:0,class:"mt-1 flex flex-wrap gap-2"},be={class:"text-xs text-gray-500"},xe={class:"border-t bg-white p-4"},ke={class:"flex items-center gap-2"},Ae=E({__name:"ChatMessage",props:{orderId:{},currentUserId:{},currentUserName:{},currentUserAvatar:{},receiverId:{}},setup(M){const g=L().props.auth.user,T=g.employee_status=="customer"?"customer":"admin";console.log("user chat"),console.log(g.employee_status);const V=[{title:"Pesan",href:"/messages"}],l=M,c=X(),f=x(""),h=x(null),n=x(l.orderId??null),B=G(()=>!!n.value),y=()=>{h.value&&(h.value.scrollTop=h.value.scrollHeight)},N=async()=>{n.value&&(await c.fetchMessages(n.value),await D(),y())},w=s=>{const t=s.sender_id===g.id;return{container:t?"justify-end":"justify-start",row:t?"flex-row-reverse":"flex-row",bubble:t?"bg-indigo-600 text-white":"border bg-white text-gray-800"}},j=s=>{var t;return s.sender_type==="admin"?"AD":te(((t=s.sender)==null?void 0:t.name)??"User")},K=s=>{const t=new Date(s);return isNaN(t.getTime())&&t.setTime(Date.now()),t.toLocaleString("id-ID",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"})},z=s=>{try{return Array.isArray(s)?s:JSON.parse(s||"[]")}catch{return[]}},I=async s=>{await c.markAsRead(s)},U=async()=>{f.value.trim()&&(await c.sendMessage({sender_type:T,receiver_id:l.receiverId,sender_name:l.currentUserName,message:f.value,order_id:n.value,content_data:""}),f.value="",await D(),y())},P=async s=>{n.value=s,await N(),await I(s)},R=()=>{n.value=null};return H(async()=>{l.orderId?(n.value=l.orderId,await N()):await c.fetchConversations()}),J(n,(s,t)=>{if(s){c.fetchMessages(s),console.log(`Subscribing to chat.${s} channel`);try{window.Echo.leave(`chat.${s}`)}catch(e){console.log("Error unsubscribing from previous channel:",e),console.log("No previous subscription to leave")}window.Echo.private(`chat.${s}`).listen(".message.sent",e=>{console.log("Received message from Pusher:",e),e.chatMessage&&(c.addMessage(e.chatMessage),y())}).error(e=>{console.error("Echo connection error:",e)})}else t&&(console.log(`Unsubscribing from chat.${t} channel`),window.Echo.leave(`chat.${t}`))}),Q(()=>{n.value&&window.Echo.leave(`chat.${n.value}`)}),(s,t)=>(r(),o(m,null,[d(i(Z),{title:"Pesan Management"}),d(se,{breadcrumbs:V},{default:_(()=>[a("div",oe,[B.value?(r(),o("div",fe,[a("div",ge,[a("h2",he,"Order #"+u(n.value),1),d(i(S),{variant:"ghost",size:"sm",class:"text-indigo-600 hover:bg-indigo-100",onClick:R},{default:_(()=>t[1]||(t[1]=[$("â† Kembali")])),_:1,__:[1]})]),a("div",me,[d(re,{ref_key:"chatContainer",ref:h,class:"h-full pr-4"},{default:_(()=>[a("div",pe,[(r(!0),o(m,null,k(i(c).messages,e=>{var b;return r(),o("div",{key:e.id,class:p(["flex",w(e).container])},[a("div",{class:p(["flex max-w-full items-start gap-3",w(e).row])},[d(i(Y),{class:"size-10 shrink-0"},{default:_(()=>[e.sender_id===l.currentUserId&&l.currentUserAvatar?(r(),q(i(O),{key:0,src:l.currentUserAvatar,alt:e.sender_name},null,8,["src","alt"])):C("",!0),d(i(ee),null,{default:_(()=>[$(u(j(e)),1)]),_:2},1024)]),_:2},1024),a("div",ve,[a("div",{class:p(["rounded-lg p-3 text-sm shadow",w(e).bubble])},[a("p",ye,u(e.message),1)],2),(b=e.content_data)!=null&&b.length?(r(),o("div",we,[(r(!0),o(m,null,k(z(e.content_data),A=>(r(),o("span",{key:A,class:"..."},u(A),1))),128))])):C("",!0),a("div",be,u(K(e.created_at)),1)])],2)],2)}),128))])]),_:1},512)]),a("div",xe,[a("div",ke,[d(i(ae),{modelValue:f.value,"onUpdate:modelValue":t[0]||(t[0]=e=>f.value=e),placeholder:"Ketik pesan...",onKeyup:W(U,["enter"]),class:"flex-1 rounded-md border px-4 py-2 text-sm"},null,8,["modelValue"]),d(i(S),{onClick:U,class:"rounded-md bg-indigo-600 px-4 py-2 text-sm text-white hover:bg-indigo-700 focus:ring-2 focus:ring-indigo-400"},{default:_(()=>t[2]||(t[2]=[$(" Kirim ")])),_:1,__:[2]})])])])):(r(),o("div",ne,[a("ul",ie,[(r(!0),o(m,null,k(i(c).conversations,e=>(r(),o("li",{key:e.order_id,class:"cursor-pointer rounded border p-3 hover:bg-gray-100",onClick:b=>P(e.order_id)},[a("div",ce,[a("div",de,"Order #"+u(e.order_id),1),e.unread_count>0?(r(),o("span",ue,u(e.unread_count),1)):C("",!0)]),a("div",_e,u(e.last_message),1)],8,le))),128))])]))])]),_:1})],64))}});export{Ae as default};
