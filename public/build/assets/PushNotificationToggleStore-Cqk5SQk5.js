import{b as m,d as _,J as N,r as h,o as k,f as u,g as l,k as n,C as g,z as b,j as p,u as v,_ as P,c as S}from"./app-Evm0gqqI.js";import{u as z}from"./useToast-BSSR4yAF.js";import{u as E}from"./usePushNotificationStore-BNJup3Db.js";class R{constructor(){this.swRegistration=null,this.isSubscribed=!1,this.applicationServerPublicKey=window.vapidPublicKey||"BKhYLRgM_Jf-Ow5eBTrGMJyEXfmCnE-UgGpjYud0eQH-TlEFxUOzCj_-HgTG08Rl9sYxFYmwxrRdLZHGJzHGBfA",this.initialize=this.initialize.bind(this),this.subscribe=this.subscribe.bind(this),this.unsubscribe=this.unsubscribe.bind(this),this.updateSubscriptionOnServer=this.updateSubscriptionOnServer.bind(this),this.removeSubscriptionFromServer=this.removeSubscriptionFromServer.bind(this),this.urlB64ToUint8Array=this.urlB64ToUint8Array.bind(this),this.checkSubscription=this.checkSubscription.bind(this)}async initialize(){try{return!("serviceWorker"in navigator)||!("PushManager"in window)?(console.warn("Push notifications are not supported by this browser"),!1):this.applicationServerPublicKey?(this.swRegistration=await navigator.serviceWorker.ready,console.log("Service Worker is ready",this.swRegistration),await this.checkSubscription(),!0):(console.error("VAPID public key is missing"),!1)}catch(s){return console.error("Error initializing push notifications:",s),!1}}async checkSubscription(){try{if(!this.swRegistration)return!1;const s=await this.swRegistration.pushManager.getSubscription();return this.isSubscribed=s!==null,console.log("User is"+(this.isSubscribed?"":" not")+" subscribed to push notifications"),this.isSubscribed&&console.log("Current subscription:",s),this.isSubscribed}catch(s){return console.error("Error checking subscription:",s),!1}}async subscribe(){try{if(this.swRegistration||await this.initialize(),!this.swRegistration)throw new Error("Service Worker registration not available");const s=this.urlB64ToUint8Array(this.applicationServerPublicKey),i=await this.swRegistration.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:s});return console.log("User is now subscribed:",i),this.isSubscribed=!0,await this.updateSubscriptionOnServer(i),i}catch(s){return console.error("Failed to subscribe user:",s),null}}async unsubscribe(){try{if(!this.swRegistration)return!1;const s=await this.swRegistration.pushManager.getSubscription();if(!s)return console.log("No subscription to unsubscribe from"),this.isSubscribed=!1,!0;const i=s.endpoint;return await s.unsubscribe(),console.log("User is now unsubscribed"),this.isSubscribed=!1,await this.removeSubscriptionFromServer(i),!0}catch(s){return console.error("Error unsubscribing:",s),!1}}async updateSubscriptionOnServer(s){try{if(!s)return console.error("No subscription to send to server"),!1;const i=s.toJSON(),r=await m.post("/api/push/subscribe",{endpoint:s.endpoint,keys:{p256dh:i.keys.p256dh,auth:i.keys.auth}});return console.log("Subscription sent to server:",r.data),r.data.success}catch(i){return console.error("Error sending subscription to server:",i),!1}}async removeSubscriptionFromServer(s){try{if(!s)return console.error("No endpoint to remove from server"),!1;const i=await m.post("/api/push/unsubscribe",{endpoint:s});return console.log("Subscription removed from server:",i.data),i.data.success}catch(i){return console.error("Error removing subscription from server:",i),!1}}urlB64ToUint8Array(s){const i="=".repeat((4-s.length%4)%4),r=(s+i).replace(/\-/g,"+").replace(/_/g,"/"),t=window.atob(r),o=new Uint8Array(t.length);for(let e=0;e<t.length;++e)o[e]=t.charCodeAt(e);return o}}const f=new R,T={class:"push-notification-toggle"},M={class:"toggle-container"},B={key:0,class:"unsupported-message"},C={key:1,class:"error-message"},F=_({__name:"PushNotificationToggle",setup(w){const{t:s}=N(),i=z(),r=h(!1),t=h(!1),o=h(!1),e=h("");k(async()=>{try{if(o.value=!0,e.value="",r.value="serviceWorker"in navigator&&"PushManager"in window,!r.value){console.log("Push notifications are not supported by this browser");return}await f.initialize()?(t.value=await f.checkSubscription(),console.log("Push notification status:",t.value?"Subscribed":"Not subscribed")):e.value=s("pushNotifications.initFailed")}catch(a){console.error("Error initializing push notifications:",a),e.value=s("pushNotifications.errorOccurred")}finally{o.value=!1}});async function d(){if(!(!r.value||o.value))try{o.value=!0,e.value="",t.value?await f.unsubscribe()?(t.value=!1,console.log("Successfully unsubscribed from push notifications"),i.success(s("pushNotifications.unsubscribeSuccess"))):(e.value=s("pushNotifications.unsubscribeFailed"),i.error(s("pushNotifications.error"))):await f.subscribe()?(t.value=!0,console.log("Successfully subscribed to push notifications"),i.success(s("pushNotifications.subscribeSuccess"))):(e.value=s("pushNotifications.subscribeFailed"),i.error(s("pushNotifications.error")))}catch(a){console.error("Error toggling push notification subscription:",a),e.value=s("pushNotifications.errorOccurred"),i.error(s("pushNotifications.error"))}finally{o.value=!1}}return(a,c)=>(l(),u("div",T,[n("div",M,[n("label",{class:b(["toggle-label",{disabled:!r.value}])},[n("span",null,p(v(s)("pushNotifications.title")),1),n("div",{class:b(["toggle-switch",{disabled:!r.value,loading:o.value}]),onClick:d},[n("div",{class:b(["toggle-slider",{active:t.value}])},c[0]||(c[0]=[n("div",{class:"toggle-button"},null,-1)]),2)],2)],2)]),r.value?g("",!0):(l(),u("p",B,p(v(s)("pushNotifications.unsupported")),1)),e.value?(l(),u("p",C,p(e.value),1)):g("",!0)]))}}),$=P(F,[["__scopeId","data-v-0039df7b"]]),O={class:"push-notification-toggle"},U={class:"toggle-container"},A={key:0,class:"unsupported-message"},x={key:1,class:"error-message"},J=_({__name:"PushNotificationToggleStore",setup(w){const{t:s}=N(),i=z(),r=E(),t=h(!1),o=S(()=>"serviceWorker"in navigator&&"PushManager"in window),e=S(()=>r.isSubscribed),d=S(()=>r.error);k(async()=>{try{if(t.value=!0,!o.value){console.log("Push notifications are not supported by this browser");return}await r.checkSubscription(),console.log("Push notification status:",e.value?"Subscribed":"Not subscribed")}catch(c){console.error("Error initializing push notifications:",c)}finally{t.value=!1}});async function a(){if(!(!o.value||t.value))try{t.value=!0,e.value?(await r.unsubscribe(),i.success(s("pushNotifications.unsubscribeSuccess"))):(await r.subscribe(),i.success(s("pushNotifications.subscribeSuccess")))}catch(c){console.error("Error toggling push notification subscription:",c),i.error(s("pushNotifications.error"))}finally{t.value=!1}}return(c,y)=>(l(),u("div",O,[n("div",U,[n("label",{class:b(["toggle-label",{disabled:!o.value}])},[n("span",null,p(v(s)("pushNotifications.title")),1),n("div",{class:b(["toggle-switch",{disabled:!o.value,loading:t.value}]),onClick:a},[n("div",{class:b(["toggle-slider",{active:e.value}])},y[0]||(y[0]=[n("div",{class:"toggle-button"},null,-1)]),2)],2)],2)]),o.value?g("",!0):(l(),u("p",A,p(v(s)("pushNotifications.unsupported")),1)),d.value?(l(),u("p",x,p(d.value),1)):g("",!0)]))}}),H=P(J,[["__scopeId","data-v-7979409a"]]);export{$ as P,H as a};
